#!/usr/bin/env node
var data = require('./libs/data');
var chart = require('./libs/chart');

var showChart = function (args) {
  data.getNOCs((nocNames) => {

    const nocs = nocNames;
    const seasons = { 'winter': 1, 'summer': 0 };
    const medals = { 'gold': 1, 'silver': 2, 'bronze': 3 };

    var noc, season, medal, year;

    args.forEach(arg => {
      if (seasons.hasOwnProperty(arg.toLowerCase())) {
        season = seasons[arg.toLowerCase()];
      }
      else if (medals.hasOwnProperty(arg.toLowerCase())) {
        medal = medals[arg.toLowerCase()] || 0;
      }
      else if (/^(18|19|20)[0-9]{2}$/.test(arg)) {
        year = arg;
      }
      else if (nocs.some(noc => noc.noc_name === arg.toUpperCase())) {
        noc = arg.toUpperCase();
      }
      else throw new Error(`Unrecognisable param: ${arg}`);
    });

    if (season === undefined) throw new Error('You have to specify season param!');

    if (noc) {
      data.getAmountOfMedals(season, noc, medal, (rows) => {
        chart.draw(rows, 'medals', ['Year', 'Amount']);
      });
    } else {
      data.getTopTeams(season, year, medal, (rows) => {
        chart.draw(rows, 'top-teams', ['NOC', 'Amount']);
      });
    }
  });
};

if (!module.parent) showChart(process.argv.slice(2));

exports.showChart = showChart;
