#!/usr/bin/env node
var data = require('./libs/data');
var chart = require('./libs/chart');
var queries = require('./libs/queries');

var args = process.argv.slice(2);

const seasons = { 'winter': 1, 'summer': 0 };
const medals = { 'gold': 1, 'silver': 2, 'bronze': 3 };

var teams;

var showChart = function () {

  var noc, season, medal, year;

  args.forEach(arg => {
    if (seasons.hasOwnProperty(arg.toLowerCase())) {
      season = seasons[arg.toLowerCase()];
    }
    else if (medals.hasOwnProperty(arg.toLowerCase())) {
      medal = medals[arg.toLowerCase()] || 0;
    }
    else if (/^(18|19|20)[0-9]{2}$/.test(arg)) {
      year = arg;
    }
    else if (teams.some(noc => noc.noc_name === arg.toUpperCase())) {
      noc = arg.toUpperCase();
    }
    else throw new Error(`Unrecognisable param: ${arg}`);
  });

  if (season === undefined) throw new Error('You have to specify season param!');

  if (noc) {
    let getAmountOfMedals = data.all(queries.getAmountOfMedalsQuery(season, noc, medal), []);
    getAmountOfMedals()
      .then((rows) => {
        rows = rows.map(row => [row.Year, row.Amount || 0]);
        chart.draw(rows, 'medals', ['Year', 'Amount']);
      })
      .catch((err) => { console.log(err); });
  } else {
    let getTopTeams = data.all(queries.getTopTeamsQuery(season, year, medal), []);
    getTopTeams()
      .then((rows) => {
        rows = rows.map(row => [row.NOC, row.Amount || 0]);
        chart.draw(rows, 'top-teams', ['NOC', 'Amount']);
      })
      .catch((err) => { console.log(err); });
    // data.getTopTeams(season, year, medal, (rows) => {
    //   chart.draw(rows, 'top-teams', ['NOC', 'Amount']);
    // });
  }
};

var main = function () {

  var getTeams = data.all(`select id, noc_name from teams`, []);

  getTeams()
    .then((rows) => { teams = rows; })
    .then(() => { showChart(); })
    .catch((err) => { console.log(err); });
};

if (!module.parent) main();

exports.showChart = main;
